(function() {
  var rows        = 8;
  var people      = ['ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‡', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ˜‰', 'ğŸ˜Š', 'â˜ºï¸', 'ğŸ˜‹', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ˜–', 'ğŸ˜—', 'ğŸ˜˜', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜£', 'ğŸ˜¤', 'ğŸ˜¥', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜¬', 'ğŸ˜­', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ˜´', 'ğŸ˜µ', 'ğŸ˜¶', 'ğŸ˜·', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜º', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ˜¾', 'ğŸ˜¿', 'ğŸ™€', 'ğŸ‘£', 'ğŸ‘¤', 'ğŸ‘¥', 'ğŸ‘¶', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘ª', /*'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§', 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§', 'ğŸ‘©â€ğŸ‘©â€ğŸ‘¦', 'ğŸ‘©â€ğŸ‘©â€ğŸ‘§', 'ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', 'ğŸ‘©â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦', 'ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§', 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§', 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦', 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘§',*/ 'ğŸ‘«', 'ğŸ‘¬', 'ğŸ‘­', 'ğŸ‘¯', 'ğŸ‘°', 'ğŸ‘±', 'ğŸ‘²', 'ğŸ‘³', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ‘®', 'ğŸ‘·', 'ğŸ‘¸', 'ğŸ’‚', 'ğŸ‘¼', 'ğŸ…', 'ğŸ‘»', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ’©', 'ğŸ’€', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ™‡', 'ğŸ’', 'ğŸ™…', 'ğŸ™†', 'ğŸ™‹', 'ğŸ™', 'ğŸ™', 'ğŸ’†', 'ğŸ’‡', 'ğŸ’‘', /*'ğŸ‘©â€â¤ï¸â€ğŸ‘©', 'ğŸ‘¨â€â¤ï¸â€ğŸ‘¨', 'ğŸ’', 'ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘©', 'ğŸ‘¨â€â¤ï¸â€ğŸ’‹â€ğŸ‘¨',*/ 'ğŸ™Œ', 'ğŸ‘', 'ğŸ‘‚', 'ğŸ‘€', 'ğŸ‘ƒ', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ‘…', 'ğŸ’…', 'ğŸ‘‹', 'ğŸ‘', 'ğŸ‘', 'â˜ï¸', 'ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ‘Š', 'âœŠ', 'âœ‹', 'ğŸ’ª', 'ğŸ‘', 'ğŸ™'];
  var nature      = ['ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸ’', 'ğŸŒ¾', 'ğŸŒ¿', 'ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸŒ°', 'ğŸ€', 'ğŸ', 'ğŸ­', 'ğŸ¹', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ®', 'ğŸ…', 'ğŸ†', 'ğŸ¯', 'ğŸ‡', 'ğŸ°', 'ğŸˆ', 'ğŸ±', 'ğŸ', 'ğŸ´', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸ“', 'ğŸ”', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ˜', 'ğŸª', 'ğŸ«', 'ğŸ—', 'ğŸ–', 'ğŸ·', 'ğŸ½', 'ğŸ•', 'ğŸ©', 'ğŸ¶', 'ğŸº', 'ğŸ»', 'ğŸ¨', 'ğŸ¼', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ‰', 'ğŸ²', 'ğŸŠ', 'ğŸ', 'ğŸ¢', 'ğŸ¸', 'ğŸ‹', 'ğŸ³', 'ğŸ¬', 'ğŸ™', 'ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸš', 'ğŸŒ', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸ¾', 'âš¡', 'ğŸ”¥', 'ğŸŒ™', 'â˜€ï¸', 'â›…ï¸', 'â˜ï¸', 'ğŸ’§', 'ğŸ’¦', 'â˜”ï¸', 'ğŸ’¨', 'â„ï¸', 'ğŸŒŸ', 'â­ï¸', 'ğŸŒ ', 'ğŸŒ„', 'ğŸŒ…', 'ğŸŒˆ', 'ğŸŒŠ', 'ğŸŒ‹', 'ğŸŒŒ', 'ğŸ—»', 'ğŸ—¾', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒš', 'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒ'];
  var food        = ['ğŸ…', 'ğŸ†', 'ğŸŒ½', 'ğŸ ', 'ğŸ‡', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ“', 'ğŸ”', 'ğŸ•', 'ğŸ–', 'ğŸ—', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ', 'ğŸ', 'ğŸ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ§', 'ğŸ¨', 'ğŸ©', 'ğŸª', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ®', 'ğŸ¯', 'ğŸ°', 'ğŸ±', 'ğŸ²', 'ğŸ³', 'ğŸ´', 'ğŸµ', 'â˜•ï¸', 'ğŸ¶', 'ğŸ·', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¼'];
  var celebration = ['ğŸ€', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ‹', 'ğŸ', 'ğŸ‘', 'ğŸ†', 'ğŸ‡', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ’«', 'âœ¨', 'ğŸ’¥', 'ğŸ“', 'ğŸ‘‘', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸŒ', 'ğŸ®', 'ğŸ’', 'â¤ï¸', 'ğŸ’”', 'ğŸ’Œ', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’œ', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™'];
  var activity    = ['ğŸƒ', 'ğŸš¶', 'ğŸ’ƒ', 'ğŸš£', 'ğŸŠ', 'ğŸ„', 'ğŸ›€', 'ğŸ‚', 'ğŸ¿', 'â›„ï¸', 'ğŸš´', 'ğŸšµ', 'ğŸ‡', 'â›ºï¸', 'ğŸ£', 'âš½ï¸', 'ğŸ€', 'ğŸˆ', 'âš¾ï¸', 'ğŸ¾', 'ğŸ‰', 'â›³ï¸', 'ğŸ†', 'ğŸ½', 'ğŸ', 'ğŸ¹', 'ğŸ¸', 'ğŸ»', 'ğŸ·', 'ğŸº', 'ğŸµ', 'ğŸ¶', 'ğŸ¼', 'ğŸ§', 'ğŸ¤', 'ğŸ­', 'ğŸ«', 'ğŸ©', 'ğŸª', 'ğŸ¬', 'ğŸ¨', 'ğŸ¯', 'ğŸ±', 'ğŸ³', 'ğŸ°', 'ğŸ²', 'ğŸ®', 'ğŸ´', 'ğŸƒ', 'ğŸ€„ï¸', 'ğŸ ', 'ğŸ¡', 'ğŸ¢'];
  var travel      = ['ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´'];
  var symbols     = ['ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´', 'ğŸŒ´'];

  var keyMap = {
    ESC: 27,
    TAB: 9,
    ENTER: 13
  };

  $.fn.zenmoji = function(options) {

    function buildTemplate(list) {
      var template = '<table class="emojis"><tbody>';

      for (var i = 0; i < list.length; i++) {
        template += '<tr>';

        for (var j = 0; j < 8 && i < list.length; j++) {
          template += '<td class="emoji">' + list[i] + '</td>';
          i++;
        }

        template += '</tr>';
      }

      return template + '</tbody></table>';
    }

    function ZenmojiView(options) {
      this.$el = $('<div class="zenmoji-view" style="display: none;">' +
                     '<div class="content">' +
                       '<input type="text">' +
                         buildTemplate(people) +
                         buildTemplate(nature) +
                         buildTemplate(food) +
                         buildTemplate(celebration) +
                         buildTemplate(activity) +
                         buildTemplate(travel) +
                         buildTemplate(symbols) +
                     '</div>' +
                   '</div>');

      this.$el.on('click', '.emojis td', options.select);
      this.$el.on('selected', this.hide.bind(this));
      $('body').append(this.$el);
    }

    ZenmojiView.prototype.show = function(offset) {
      this.$el.css({
        left: offset.left,
        top: offset.top + offset.height
      });

      this.$el.show();
    };

    ZenmojiView.prototype.hide = function() {
      this.$el.hide();
    };

    function getToken(textarea, position) {
      var text = textarea.val().slice(0, position);
      var matches = /\:[A-Za-z]*$/.exec(text);

      return matches;
    }

    this.each(function(index, el) {
      var $el = $(el);

      $el.data('view', new ZenmojiView({
        select: function(event) {
          var emoji    = $(event.target).text(),
              text     = $el.val(),
              position = $el.caret('pos');


          $el.val(text.slice(0, position - 1) + emoji + text.slice(position));
          $(event.target).trigger('selected');
          $el.focus();
          $el.caret('pos', position);
        }
      }));

      $el.on('keyup', function(event) {
        var view     = $(this).data('view'),
            position = $(this).caret('pos'),
            offset   = $(this).caret('offset'),
            token    = getToken($(this), position);

        if (event.which == keyMap.ESC) {
          view.hide();
        } else {
          if (token) {
            view.show(offset);
          } else {
            view.hide(offset);
          }
        }
      });
    });
  }
}());
